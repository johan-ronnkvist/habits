<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug IndexedDB</title>
</head>
<body>
    <h1>IndexedDB Debug</h1>
    <button onclick="checkDatabase()">Check Database</button>
    <button onclick="clearDatabase()">Clear Database</button>
    <div id="output"></div>

    <script>
        const DB_NAME = 'BetterHabitsDB'
        const DB_VERSION = 2
        const HABITS_STORE = 'habits'

        function log(message) {
            const output = document.getElementById('output')
            output.innerHTML += `<p>${message}</p>`
            console.log(message)
        }

        async function checkDatabase() {
            log('üîç Checking database...')
            
            try {
                // Open database
                const db = await openDatabase()
                log(`‚úÖ Database opened: ${db.name} v${db.version}`)
                
                // List object stores
                const storeNames = Array.from(db.objectStoreNames)
                log(`üì¶ Object stores: ${storeNames.join(', ')}`)
                
                // Check habits
                const transaction = db.transaction([HABITS_STORE], 'readonly')
                const store = transaction.objectStore(HABITS_STORE)
                
                // List indexes
                const indexNames = Array.from(store.indexNames)
                log(`üìá Indexes: ${indexNames.join(', ')}`)
                
                // Get all habits
                const habits = await getAllFromStore(store)
                log(`üìã Found ${habits.length} habits:`)
                habits.forEach((habit, i) => {
                    log(`  ${i + 1}. ${habit.name} (sortOrder: ${habit.sortOrder})`)
                })
                
                db.close()
            } catch (error) {
                log(`‚ùå Error: ${error.message}`)
            }
        }
        
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION)
                
                request.onerror = () => reject(request.error)
                request.onsuccess = () => resolve(request.result)
                
                request.onupgradeneeded = (event) => {
                    log(`üîß Database upgrade: ${event.oldVersion} -> ${event.newVersion}`)
                    const database = event.target.result
                    const oldVersion = event.oldVersion
                    
                    if (!database.objectStoreNames.contains(HABITS_STORE)) {
                        log('üì¶ Creating habits store')
                        const store = database.createObjectStore(HABITS_STORE, { keyPath: 'id' })
                        store.createIndex('createdAt', 'createdAt', { unique: false })
                        store.createIndex('name', 'name', { unique: false })
                        store.createIndex('sortOrder', 'sortOrder', { unique: false })
                    } else if (oldVersion < 2) {
                        log('üîß Adding sortOrder index')
                        const transaction = event.target.transaction
                        const store = transaction.objectStore(HABITS_STORE)
                        if (!store.indexNames.contains('sortOrder')) {
                            store.createIndex('sortOrder', 'sortOrder', { unique: false })
                            log('‚úÖ sortOrder index added')
                        }
                    }
                }
            })
        }
        
        function getAllFromStore(store) {
            return new Promise((resolve, reject) => {
                const request = store.getAll()
                request.onsuccess = () => resolve(request.result)
                request.onerror = () => reject(request.error)
            })
        }
        
        async function clearDatabase() {
            if (confirm('Are you sure you want to clear the database?')) {
                try {
                    const deleteRequest = indexedDB.deleteDatabase(DB_NAME)
                    await new Promise((resolve, reject) => {
                        deleteRequest.onsuccess = () => resolve()
                        deleteRequest.onerror = () => reject(deleteRequest.error)
                    })
                    log('üóëÔ∏è Database cleared')
                    document.getElementById('output').innerHTML = ''
                } catch (error) {
                    log(`‚ùå Error clearing database: ${error.message}`)
                }
            }
        }
    </script>
</body>
</html>